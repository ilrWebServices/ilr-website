<?php

define('LOCK_MESSAGE', 'This block is locked and cannot be edited.');

/**
 * Implements hook_form_alter().
 * Adds the admin_lock setting checkbox
 * Hides the lock setting from non-admins.
 * Add validation callback to check lock status
 */
function ilr_admin_lock_form_bean_form_alter(&$form, &$form_state) {
  global $user;

  $form['admin_lock'] = array(
    '#type' => 'checkbox',
    '#title' => t('Lock this block'),
    '#weight' => 0,
    '#default_value' => _ilr_admin_lock_get_lock_value($form['bean']['#value']),
  );

  $form['#validate'][] = '_ilr_admin_lock_validate_permissions';

  if (!user_access('administer bean settings', $user)) {
    if (_ilr_admin_lock_get_lock_value($form['bean']['#value']) == 1) {
      drupal_set_message(LOCK_MESSAGE, 'warning');
    }
    $form['admin_lock']['#access'] = FALSE;
  }
}

/**
 * Validation callback to check lock status of bean
 * Prevents users without sufficient privileges from editing a locked bean
 */
function _ilr_admin_lock_validate_permissions($form, &$form_state) {
  global $user;
  if (!user_access('administer bean settings', $user) && _ilr_admin_lock_bean_is_locked($form['bean']['#value'])) {
    form_set_error('admin_lock', t(LOCK_MESSAGE));
  }

}

/**
 * Wrapper function that improves code readability
 */
function _ilr_admin_lock_bean_is_locked($bean) {
  return _ilr_admin_lock_get_lock_value($bean);
}

/**
 * Checks the admin_lock status of the bean
 */
function _ilr_admin_lock_get_lock_value($bean) {
  $value = 0;
  if (isset($bean->data['admin_lock'])) {
    $value = $bean->data['admin_lock'];
  }
  return $value;
}

/**
 * Implements hook_entity_presave().
 * Adds the admin_lock key to the data column of the bean
 */
function ilr_admin_lock_entity_presave($entity, $type) {
  if ($type == 'bean') {
    $entity->data['admin_lock'] = $entity->admin_lock;
  }
}

/**
 * Implements hook_field_extra_fields().
 */
function ilr_admin_lock_field_extra_fields() {
  $extra = array();
  foreach (bean_get_types() as $type) {
    $extra['bean'][$type->type]['form']['admin_lock'] = array(
      'label' => t('Admin lock'),
      'description' => t('Admin lock module element'),
      'weight' => 10,
     );
  }
  return $extra;
}
