<?php

require_once DRUPAL_ROOT . '/../config/get_secrets.php';

/**
 * Implements hook_install()
 * Loops through the roles in the system and creates a test user for that role
 */

function ilr_dev_install() {
  variable_set('site_name','ILR Dev Site');
  variable_set('file_public_path','sites/default/files');
  variable_set('stage_file_proxy_origin','http://www.ilr.cornell.edu');
  variable_set('stage_file_proxy_origin_dir','sites/ilr.cornell.edu/files');
  variable_set('features_rebuild_on_flush',FALSE);
  variable_set('entity_rebuild_on_flush',FALSE);

  // Disable any modules we don't want running locally
  module_disable(array(
    'securepages',
    'memcache',
    'google_analytics_universal',
  ));

  // Allow anonymous users to see dpm messages locally
  if (module_exists('devel')) {
    user_role_grant_permissions(DRUPAL_ANONYMOUS_RID, array('access devel information'));
  }

  if (module_exists('freedompay')) {
    _ilr_dev_set_freedompay_test_credentials();
  }
}

/**
 * Updates the hpp values for testing when local
 */
function _ilr_dev_set_freedompay_test_credentials() {
  global $ILR_SECRETS;
  $portals = FreedompayHpp::getPortals();
  if (!empty($portals)) {
    foreach ($portals as $portal) {
      $name = strtolower($portal->title);
      if (array_key_exists($name, $ILR_SECRETS['freedompay'])) {
        $portal->store_id = $ILR_SECRETS['freedompay'][$name]['testing']['store_id'];
        $portal->terminal_id = $ILR_SECRETS['freedompay'][$name]['testing']['terminal_id'];
        $portal->save();
      }
    }
  }
}
