<?php

function cul_hours_block_info() {
  $blocks['library_hours_today'] = array(
    'info' => t('Today\'s Library Hours'),
  );
  $blocks['library_hours_semester'] = array(
    'info' => t('Semester Library Hours'),
  );
  return $blocks;
}

function cul_hours_block_view($delta='') {
  $subject = ($delta == 'library_hours_today') ? 'Today\'s Hours' : '';
  $generator = ($delta == 'library_hours_today')
    ? _cul_hours_generate_markup()
    : _cul_hours_get_generated_markup();
  $block = array(
    'subject' => $subject,
    'content' => $generator,
  );
  return $block;
}

function _cul_hours_get_generated_markup() {
  if ($cache = cache_get('cul_semester_hours')) {
    $markup = $cache->data;
  } else {
    $url = "http://mannservices.mannlib.cornell.edu/LibServices/showLibraryHoursForAcademicSemester.do?location=ILR&output=xhtml";
    $markup = file_get_contents($url);
    cache_set('cul_semester_hours', $markup, 'cache', time() + 60 * 60 * 24 * 7);// 60 * 60 * 24 * 7 = 1 week
  }
  return $markup;
}

/**
 * Generates the markup for today's hours
 */
function _cul_hours_generate_markup() {
  $markup = '<div class="library-hours">';
  $hours_json = _cul_hours_get_json();
  if (!empty($hours_json)) {
    $markup .= _cul_hours_format_timestamp($hours_json['startTime'], $hours_json['endTime']);
  }
  $markup .= "</div>";
  return $markup;
}

function _cul_hours_format_timestamp($start, $end=NULL) {
  $markup = date('g:i a', $start);
  if ($end) {
    $markup .= ' - ' . date('g:i a', $end);
  }
  return $markup;
}

/**
 * Retrieves the json from manlib site or the cache
 */
function _cul_hours_get_json() {
  if ($cache = cache_get('cul_hours')) {
    $hours_json = $cache->data;
  } else {
    $url = "http://mannservices.mannlib.cornell.edu/LibServices/showLibraryHoursToday.do?location=ILR&output=json";
    $data = file_get_contents($url);
    $json = json_decode($data, true);
    $hours_json = $json;
    cache_set('cul_hours', $hours_json, 'cache', time() + 60 * 60 * 24);// 60 * 60 * 24 = 24 hours
  }
  return $hours_json;
}
