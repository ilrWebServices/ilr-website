<?php

/**
 * Implements hook_bean_types_api_info().
 */
function tagged_content_block_bean_types_api_info() {
  return array('api' => 4);
}

/**
 * Implements hook_bean_types().
 */
function tagged_content_block_bean_types() {
  $plugins = array();
  $plugins['tagged_content'] = array(
    'label' => t('Tagged content'),
    'description' => t('Provides a listing of teasers for chosen content types that are tagged.'),
    'handler' => array(
      'class' => 'TaggedContentBean',
      'parent' => 'bean',
      'path' => drupal_get_path('module', 'tagged_content_block') . '/plugins/bean',
      'file' => 'tagged_content.inc',
    ),
  );
  return $plugins;
}

/**
 * Implements hook_permission()
 */
function tagged_content_block_permission() {
  return array(
    'administer tagged content block configuration' => array(
      'title' => t('Administer Tagged Content Blocks'),
      'description' => t('Configure content types available to tagged content blocks.'),
    ),
  );
}

/**
* Implements hook_menu().
*/
function tagged_content_block_menu() {
  $items = array();
  $items['admin/config/content/tagged_content'] = array(
    'title' => t('Tagged Content Block Settings'),
    'description' => t('Configure content types available to tagged content blocks'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tagged_content_block_admin'),
    'file' => 'includes/tagged_content_block.admin.inc',
    'access arguments' => array('administer tagged content block configuration'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Implementation of hook_query_TAG_alter
 */
function tagged_content_block_query_random_alter($query) {
  $query->orderRandom();
}

/**
 * Implements hook_form_alter
 * Adds a validator for tagged content blocks
 */
function tagged_content_block_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == "basic_page_node_form") {
    $form['#validate'][] = '_tagged_content_block_reference_validator';
  }
}

/**
 * Validator for referencing blocks
 *   - Confirms that highlighted blocks have the featured flag
 */
function _tagged_content_block_reference_validator($form, &$form_state) {
  if(count($form_state['values']['field_blocks'][LANGUAGE_NONE][0]['field_highlighted_region'])
    && $bid = $form_state['values']['field_blocks'][LANGUAGE_NONE][0]['field_highlighted_region'][LANGUAGE_NONE][0]['bid']) {
    $block = _tagged_content_block_load_block($bid);
    $bean = bean_load_delta($block['delta']);
    if (empty($bean->data['featured'])) {
      form_set_error('state', t("Only featured blocks can be added to the highlighted region."));
    }
  }
}

/**
 * Loads a block by block id
 */
function _tagged_content_block_load_block($bid) {
  return db_query("SELECT * FROM block WHERE bid = :bid", array(':bid' => $bid))->fetchAssoc();
}

/**
 * Enables default content types for tagged content blocks
 * @return array The default content types, needed by
 * _tagged_content_block_default_bundles() of admin.inc
 */
function _tagged_content_block_enable_default_bundles() {
  $enabled_content_types = array(
    'news_item' => 'news_item',
    'spotlight' => 'spotlight',
    'promo'     => 'promo',
    'youtube_video' => 'youtube_video',
    'workspan' => 'workspan',
  );

  variable_set(
    'tagged_content_block_enabled_bundles',
    $enabled_content_types
  );

  return $enabled_content_types;
}
