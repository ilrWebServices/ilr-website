<?php
/**
 * @file
 * Code for the ilr_sdc_listings feature.
 *
 * Current Course listings
 *  Courses By Month: /professional-programs/public-offerings/calendar-month
 *  Courses By Date:  /professional-programs/public-offerings
 *  All Courses: /professional-programs/public-offerings-courses
 *
 */
define('ILR_SDC_MAX_DAYS_PAST', 90);
define('ILR_SDC_ONLINE_TEXT', 'Online');
define('ILR_SDC_ONDEMAND_TEXT', 'This is an on demand class.');
define('ILR_SDC_PATH_ALIAS', 'professional-programs/public-offerings');
include_once 'ilr_sdc_listings.features.inc';


/**
 * Implements hook_playlist_feeds_after_import().
 *
 * Automatically run other imports after course import is run.
 * Run faculty/class assigner.
 */
function ilr_sdc_listings_feeds_after_import(FeedsSource $source) {
  $chained_importers = _ilr_sdc_listings_get_importer_ids();
  $importer_index = array_search($source->importer->id, $chained_importers);
  if ($importer_index !== FALSE) {
    if ($importer_index < count($chained_importers) - 1) {
      // Run the next importer automatically.
      $source = feeds_source($chained_importers[$importer_index + 1]);
      if ($source) {
        $source->startImport();
      }
    }
    else {
      module_load_include('inc', 'ilr_sdc_listings', 'ilr_sdc_listings.feeds');
      // Last importer assign faculty to classes
      _ilr_sdc_listings_set_faculty_for_classes();
    }
  }
}

/**
 * Implements hook_feeds_after_parse().
 *
 * Loop through all results from feed and prepare for import.
 */
function ilr_sdc_listings_feeds_after_parse(FeedsSource $source, FeedsParserResult $result) {
  module_load_include('inc', 'ilr_sdc_listings', 'ilr_sdc_listings.feeds');
  $importer_ids = _ilr_sdc_listings_get_importer_ids();

  if (in_array($source->importer->id, $importer_ids)) {
    // These importer might take a longtime.
    set_time_limit(600);
    foreach ($result->items as &$item) {
      _ilr_sdc_listings_prepare_source_item($item, $source);
    }
  }
}

/**
 * Implements hook_feeds_presave().
 * Protects certain fields from being changed by the import
 * New classes that are part of a series are unpublished by default
 */
function ilr_sdc_listings_feeds_presave($source, $entity, $item, $entity_id) {
  if (substr($source->importer->id, 0, 3) == 'sdc') {
    if ($entity_id) { // Pre-existing items have an $entity_id
      $fields_protected_from_import = _ilr_sdc_listings_get_feeds_protected_fields();
      // Load the unchanged entity
      $existing_node = entity_load_unchanged('node', $entity_id);
      $existing_node_wrapper = entity_metadata_wrapper('node', $existing_node);
      $updated_node_wrapper = entity_metadata_wrapper('node', $entity);
      foreach ($fields_protected_from_import[$source->importer->id] as $key => $field_name) {
        $existing_value = $existing_node_wrapper->{$field_name}->value();
        $updated_node_wrapper->{$field_name} = $existing_value;
      }
    } // Check the new item to see if it's a class
    elseif ($source->importer->id == 'sdc_class') {
      if (_ilr_sdc_listings_is_series($entity)) {
        $new_node_wrapper = entity_metadata_wrapper('node', $entity);
        $new_node_wrapper->status = 0;
      }
    }
  }
}

/**
 * Implements hook_form_alter().
 * Removes protected fields from sdc-related node forms
 */
function ilr_sdc_listings_form_alter(&$form, &$form_state, $form_id) {
  $node_forms_to_alter = array(
    'sdc_class_node_form',
    'sdc_course_node_form',
    'sdc_faculty_node_form',
  );
  if (in_array($form_id, $node_forms_to_alter)) {
    $protected_fields = _ilr_sdc_listings_get_protected_fields();
    foreach ($protected_fields[$form_id] as $key => $field_name) {
      if (isset($form[$field_name])) {
        $form[$field_name]['#disabled'] = 1;
      }
    }
  }
}

/**
 * Get importer files.
 * @return array
 *  Key are importer ids. Values are names of import files.
 */
function _ilr_sdc_listings_get_importer_files() {
  $importer_files = array(
    'sdc_course_importer' => 'ncourse',
    'sdc_class_importer' => 'nclass',
    'sdc_faculty_importer' => 'facultyFromSDC',
  );
  return $importer_files;
}

/**
 * Implements hook_menu().
 *
 * Provide callback for redirecting from catalog number to node.
 */
function ilr_sdc_listings_menu() {
  $items = array();

  $items['catalog-course/%'] = array(
    'type' => MENU_CALLBACK,
    'access arguments' => array('access content'),
    'page callback' => '_ilr_sdc_listings_catalog_redirect',
    'page arguments' => array(1),
  );

  $items['course-interest/%'] = array(
    'type' => MENU_CALLBACK,
    'access arguments' => array('access content'),
    'page callback' => '_ilr_sdc_listings_request_info',
    'page arguments' => array(1),
  );
  return $items;
}

/**
 * Redirect to the node page the matches the catalog number.
 * @param $catalog_num
 * @return int
 */
function _ilr_sdc_listings_catalog_redirect($catalog_prefix) {
  $nid = _ilr_sdc_listings_get_nid_from_catalog_prefix($catalog_prefix);
  if ($nid) {
    drupal_goto("node/$nid");
    return;
  }
  return MENU_NOT_FOUND;
}
function _ilr_sdc_listings_get_nid_from_catalog_prefix($catalog_prefix) {
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'sdc_course')
    ->fieldCondition('field_catalog_prefix', 'value', $catalog_prefix);
  $results = $query->execute();
  if (!empty($results['node'])) {
    $nid = array_pop(array_keys($results['node']));
    return $nid;
  }
  return FALSE;
}

/**
 * Hides the course field from the view
 * not working from manage display tab
 */
function _ilr_sdc_listings_request_info($course_nid) {
  $block = entityform_block_block_view('course_request');
  unset($block['content']['field_course']);
  $content = drupal_render($block['content']);
  return $content;
}

/**
 * Implements hook_node_view().
 */
function ilr_sdc_listings_node_view($node, $view_mode, $langcode) {
  switch ($node->type) {
    case 'sdc_course':
      _ilr_sdc_listings_add_prefix_to_title($node, $node->type);
      _ilr_sdc_listings_course_add_classes($node, $view_mode);

      if ($view_mode == 'reference_field') {
        _ilr_sdc_listings_update_reference($node);
      }
      elseif ($view_mode == 'teaser') {
        $original_markup = isset($node->content['body'])
          ? $node->content['body'][0]['#markup']
          : '';
        $alias = drupal_get_path_alias('node/'.$node->nid);
        $node->content['body'][0]['#markup'] = '<h2><a href="/'.$alias.'">'.$node->title.'</a></h2>' . $original_markup;
        $node->title = '';
      }
      break;
    case 'sdc_class':
      _ilr_sdc_listings_add_prefix_to_title($node, $node->type);
      _ilr_sdc_listings_class_empty_msg($node, $view_mode);
      _ilr_sdc_listings_class_add_reg_form($node, $view_mode);
      _ilr_sdc_listings_class_add_readmore($node, $view_mode);
      _ilr_sdc_listings_class_format_online($node, $view_mode);
      break;
  }
}

/**
 * Add special link to class detail
 * @param $node
 * @param $read_more_link
 */
function _ilr_sdc_listings_class_add_readmore(&$node, $view_mode) {
  if ($view_mode == 'reference_field') {
    $node_title_stripped = strip_tags($node->title);
    $links['node-readmore'] = array(
      'title' => t('Learn more about this class and its faculty'),
      'href' => 'node/' . $node->nid,
      'html' => TRUE,
      'attributes' => array('rel' => 'tag', 'title' => $node_title_stripped),
    );
    $node->content['links']['node'] = array(
      '#theme' => 'links__node__node',
      '#links' => $links,
      '#attributes' => array('class' => array('links', 'inline')),
    );
  }
}

/**
 * Implements hook_node_view_alter().
 */
function ilr_sdc_listings_node_view_alter(&$build) {
  if ($build['#bundle'] == 'sdc_class') {
    _ilr_sdc_listings_class_view_alter($build);
  }
}

/**
 * Alters Class node view.
 *
 * Remove most elements from address.
 *
 * Add course link.
 * @param $build
 */
function _ilr_sdc_listings_class_view_alter(&$build) {
  if ($build['#view_mode'] == 'teaser') {
    if (isset($build['field_address'][0]['#address'])) {
      $address_elements = array('locality', 'administrative_area');
      foreach (element_children($build['field_address'][0]['#address']) as $element) {
        if (!in_array($element, $address_elements)) {
          $build['field_address'][0]['#address'][$element] = NULL;
        }
      }
    }
    unset($build['links']);
    $build['field_course'][0] = _ilr_sdc_listings_class_course_link($build['#node']);
  }
}

/**
 * Update class link to point to class node detail
 * @param $class_node
 * @return array
 *  Render array for link.
 */
function _ilr_sdc_listings_class_course_link($class_node) {
  $node_wrapper = ilr_get_node_wrapper($class_node);
  $course_title = $node_wrapper->title->value();
  return array(
    '#theme' => 'link',
    '#text' => $course_title,
    '#path' => 'node/' . $class_node->nid,
    '#options' => array(
      'html' => FALSE,
      'attributes' => array(),
    ),
  );
}

/**
 * Remove address if class is online.
 * @param $node
 * @param $view_mode
 */
function _ilr_sdc_listings_class_format_online($node, $view_mode) {
  $node_wrapper = ilr_get_node_wrapper($node);
  if ($node_wrapper->field_online_class->value()) {
    $online_field_weight = $node->content['field_address']['#weight'];
    unset($node->content['field_address']);
    $node->content['field_address'] = array(
      '#type' => 'markup',
      '#markup' => t(ILR_SDC_ONLINE_TEXT),
      '#weight' => $online_field_weight,
    );
  }
}

/**
 * Checks the on_demand field value, as well as the catalog_prefix
 * As of 2015, all on-demand classes start with OD prefix, though sometimes
 * on-demand classes have come through the feed without being flagged as such
 */
function _ilr_sdc_listings_is_ondemand($node) {
  if ($node->type == 'sdc_class') {
    $node_wrapper = ilr_get_node_wrapper($node);
    return $node_wrapper->field_on_demand->value() || substr($node_wrapper->field_course->field_catalog_prefix->value(), 0, 2) == 'OD';
  }
  return FALSE;
}

/**
 * Checks the course or class for the appropriate course's series flag
 */
function _ilr_sdc_listings_is_series($course_or_class) {
  if ($course_or_class->type == 'sdc_course') {
    $course = $course_or_class;
  }
  else {
    $class_wrapper = ilr_get_node_wrapper($course_or_class);
    $course = $class_wrapper->field_course->value();
  }
  $course_wrapper = ilr_get_node_wrapper($course);
  return $course_wrapper->field_course_series->value();
}

/**
 * Add Class registratrion for to full course node view.
 *
 * @param $node
 * @param $view_mode
 */
function _ilr_sdc_listings_class_add_reg_form($class_node, $view_mode) {
  if ($view_mode == 'full') {
    $class_node_wrapper = ilr_get_node_wrapper($class_node);
    $course = $class_node_wrapper->field_course->value();
    $class_available = _ilr_sdc_listings_get_classes_for_course($course, array($class_node->nid));
    if ($class_available) {
      $available_classes = _ilr_sdc_listings_get_classes_for_course($course);
      $form = drupal_get_form('ilr_sdc_listings_class_reg_form', array($class_node), TRUE, FALSE);
      $class_node->content['classes'] = $form;
      $class_node->content['#group_children']['classes'] = 'group_sidebar';
      // Add a link to other classes if more than 1
      if (count($available_classes) > 1) {
        $link_text = (_ilr_sdc_listings_is_series($course))
          ? 'See other classes in this series'
          : 'Show all dates';
        $class_node->content['other_classes_link'] = array(
          '#markup' => '<p><a href="/node/'.$course->nid.'">'.$link_text.'</a></p>',
        );
        $class_node->content['#group_children']['other_classes_link'] = 'group_sidebar';
      }
    } // Class in the past
    else {
      $class_details = '<div class="class-details">';
      $class_details .= _ilr_sdc_listings_get_class_detail_markup(array($class_node->nid => $class_node));
      $class_details .= '</div>';
      $class_node->content['classes']['#markup'] = $class_details;
      $class_node->content['#group_children']['classes'] = 'group_sidebar';
    }
  }
}

/**
 * Add empty message to node class view.
 * @param $course_node
 * @param $view_mode
 */
function _ilr_sdc_listings_class_empty_msg($class_node, $view_mode) {
  $node_wrapper = ilr_get_node_wrapper($class_node);
  if ($node_wrapper->field_is_full->value()) {
    switch ($view_mode) {
      case 'teaser':
        $full_msg = '[' . variable_get('sdc_class_full_teaser') . ']';
        $weight = 100;
        break;
      default:
        $full_msg = '[' . variable_get('sdc_class_full_full') .']';
        $weight = -100;
        break;
    }
    $class_node->content['full_message'] = array(
      '#type' => 'markup',
      '#markup' => $full_msg,
      '#weight' => $weight,
    );
  }
}

/**
 * Add class listing form to node course view.
 * @param $course_node
 * @param $view_mode
 */
function _ilr_sdc_listings_course_add_classes(&$course_node, $view_mode) {
  if ($view_mode == 'teaser' || $view_mode == 'full') {
    $class_nids = _ilr_sdc_listings_get_classes_for_course($course_node);
    if ($class_nids) {
      $class_nodes = node_load_multiple($class_nids);
      if ($view_mode == 'full') {
        $form = drupal_get_form('ilr_sdc_listings_class_reg_form', $class_nodes);
        $content = drupal_render($form);
      } // teaser list view
      else {
        $content = _ilr_sdc_listings_generate_class_link_markup($class_nodes);
      }
      if (_ilr_sdc_listings_is_series($course_node)) {
        // Add the teaser for each class
        foreach ($class_nodes as $key => $class) {
          $class_teaser = node_view($class,'teaser');
          // Hide the field data we don't want
          unset($class_teaser['field_class_dates']);
          unset($class_teaser['field_address']);
          // Create and position the sidebar content
          $group_sidebar = field_group_load_field_group('group_sidebar', 'node', 'sdc_class', 'default');
          $class_teaser['classes'] = array(
            '#markup' => _ilr_sdc_listings_generate_class_link_markup(array($class)),
          );
          $class_teaser['#groups']['group_sidebar'] = $class_teaser['#fieldgroups']['group_sidebar'] = $group_sidebar;
          $class_teaser['#group_children']['classes'] = 'group_sidebar';
          // Add the markup to the course body
          $course_node->content['body'][0]['#markup'] .= drupal_render($class_teaser);
        }
      } // Not a series
      else {
        $course_node->content['classes'] = array('#markup' => $content);
        $course_node->content['#group_children']['classes'] = 'group_sidebar';
      }
    } // No classes available
    else {
      $course_node->content['classes'] = array(
        '#type' => 'markup',
        '#markup' => '<div class="group-sidebar class-details">' . _ilr_sdc_listings_generate_request_info_markup($course_node) . '</div>',
      );
    }
    $course_node->content['classes']['#weight'] = 2;
  }
}

/**
 * Form function to create class registration form.
 *
 * @param $form
 * @param $form_state
 * @param $class_nodes
 * @param $
 *
 * @return array
 */
function ilr_sdc_listings_class_reg_form($form, &$form_state, $class_nodes) {
  $form['#attributes']['class'][] = 'class-details';
  $form['addClass'] = array(
    '#tree' => TRUE,
  );
  _ilr_sdc_listings_add_radio_markup($form, $class_nodes);
  $markup = _ilr_sdc_listings_get_class_detail_markup($class_nodes, TRUE);
  $form['class_detail_toggle'] = array(
    '#type' => 'markup',
    '#markup' => $markup,
  );
  return $form;
}

/**
 * Validation callback for ilr_sdc_listings_class_reg_form.
 *
 * Ensure class selected. Required not working for "radio" type.
 */
function ilr_sdc_listings_class_reg_form_validate($form, &$form_state) {
  if (empty($form_state['values']['addClass'])) {
    form_set_error('addClass', t('You must select a session.'));
  }
}

/**
 * Submit callback for ilr_sdc_listings_class_reg_form.
 *
 * Redirect to registration page.
 */
function ilr_sdc_listings_class_reg_form_submit($form, &$form_state) {
  drupal_goto(variable_get('ilr_sdc_listings_reg_url', 'http://register.ilr.cornell.edu/registration/process/processcard.cfm'),
    array('query' => array(
      'addClass' => $form_state['values']['addClass'],
      'courseurl' => $form_state['values']['courseurl'],
    )));
}

/**
 * Retrieve the class nid from the url.
 * @return int|null
 */
function _ilr_sdc_listings_get_class_from_url() {
  if (!empty($_GET['class'])) {
    $class_selected = $_GET['class'];
    if (is_numeric($class_selected)) {
      return $class_selected;
    }
  }
  return NULL;
}

/**
 * Determines if any of the classes for course have different prices.
 * @param $class_nodes
 * @param $course_node
 * @return bool
 */
function _ilr_sdc_listings_class_has_override_price($class_nodes, $course_node) {
  $course_wrapper = ilr_get_node_wrapper($course_node);
  $course_price = $course_wrapper->field_price->value();
  foreach ($class_nodes as $class_node) {
    $class_wrapper = ilr_get_node_wrapper($class_node);
    if ($course_price != $class_wrapper->field_price->value()) {
      return TRUE;
    }
  }
  return FALSE;
}

/**
 * Determines if any of the classes for course have different titles.
 * @param $class_nodes
 * @param $course_node
 * @return bool
 */
function _ilr_sdc_listings_class_has_override_title($course_node) {
  $course_wrapper = ilr_get_node_wrapper($course_node);
  return drupal_get_title() != $course_wrapper->label();
}

function _ilr_sdc_listings_format_class_date_and_time($class) {
  $wrapper = ilr_get_node_wrapper($class);
  $datetimes = _ilr_sdc_listings_get_datetimes_for_class($class);
  $start_datetime = $datetimes['start'];
  $end_datetime = $datetimes['end'];
  $markup = '<div class="date-time">';
  $markup .= '<span class="date">';
  $year = $start_datetime->format('Y');
  if (_ilr_sdc_listings_is_multiday_event($class)) {
    if ($start_datetime->format('M') != $end_datetime->format('M')) {
      $end_day = $end_datetime->format('M j');
    }
    else {
      $end_day = $end_datetime->format('j');
    }
    $markup .=  $start_datetime->format('M j-') . $end_day . ", $year";
  }
  else {
    $markup .= $start_datetime->format('M j') . ", $year";
  }
  $markup .= '</span>';
  $markup .= '<span class="time">' . $start_datetime->format('g:i a') . ' - ';
  $markup .= $end_datetime->format('g:i a') . '</span>';
  $markup .= '</div>';
  return $markup;
}

function _ilr_sdc_listings_is_multiday_event($class) {
  $datetimes = _ilr_sdc_listings_get_datetimes_for_class($class);
  $interval = $datetimes['start']->diff($datetimes['end']);
  return $interval->d > 0;
}

function _ilr_sdc_listings_is_multiyear_event($class) {
  $datetimes = _ilr_sdc_listings_get_datetimes_for_class($class);
  $interval = $datetimes['start']->diff($datetimes['end']);
  return $interval->y > 0;
}

function _ilr_sdc_listings_generate_class_button_markup($class_node, $include_price=FALSE) {
  $wrapper = ilr_get_node_wrapper($class_node);
  if ($include_price) {
    $classes = 'button button-register';
    $link_text = 'Register';
    $link = _ilr_sdc_listings_get_class_registration_url($class_node);
  }
  else {
    $classes = 'button button-info';
    $link_text = 'Learn More';
    $link = url('node/'. $class_node->nid);
  }
  $markup = '<div class="action"><a class="'.$classes.'" href="'.$link.'">' . $link_text;
  $markup .= '<span class="cost">$' . $wrapper->field_price->value() . '</span></a></div>';

  return $markup;
}

function _ilr_sdc_listings_generate_class_radio_label($class) {
  $markup = '<div class="radio-label">';
  if (_ilr_sdc_listings_is_series($class)) {
    $markup .= '<span class="class-title">'.$class->title.'</span>';
  }
  $markup .= _ilr_sdc_listings_generate_class_time_location_markup($class);
  if(_ilr_sdc_listings_has_registration_deadline($class)) {
    $markup .= _ilr_sdc_listings_generate_deadline_markup($class);
  }
  $markup .= '</div>';

  return $markup;
}
/**
 * Generates the markup for landing pages
 */
function _ilr_sdc_listings_generate_class_link_markup($class_nodes) {
  $class_node = reset($class_nodes);
  $markup = '<div class="class-details">';
  if (_ilr_sdc_listings_is_ondemand($class_node)) {
    $markup .= '<span class="timespan">ON-DEMAND</span>';
  }
  else {
    $markup .= _ilr_sdc_listings_generate_class_timespan_markup($class_node);
    $markup .= _ilr_sdc_listings_generate_class_time_location_markup($class_node);
  }
  $markup .= _ilr_sdc_listings_generate_class_button_markup($class_node);
  if (count($class_nodes) > 1) {
    $wrapper = ilr_get_node_wrapper($class_node);
    $course_nid = $wrapper->field_course->value()->nid;
    $markup .= '<a href="/node/' . $course_nid . '">See more dates and locations</a>';
  }
  $markup .= '</div>';
  return $markup;
}

function _ilr_sdc_listings_generate_faculty_markup($class_node, $class_id) {
  $wrapper = ilr_get_node_wrapper($class_node);
  $faculty = $wrapper->field_faculty->value();
  $markup = '<div class="instructors class-' . $class_id . '">';
  $markup .= "<h3>Instructors</h3>";
  foreach ($faculty as $key => $instructor) {
    $markup .= '<div class="instructor"><h4>'. $instructor->title .'</h4>';
    $markup .= '<div class="bio">'.$instructor->body[LANGUAGE_NONE][0]['value'] . '</div></div>';
  }
  $markup .= "</div>\n";
  return $markup;
}

function _ilr_sdc_listings_generate_location_markup($class) {
  $wrapper = ilr_get_node_wrapper($class);
  $city = $wrapper->field_address->locality->value();
  $state = $wrapper->field_address->administrative_area->value();
  $handlers = array('address' => 'address');
  $context = array('mode' => 'render');
  $addressfield_object = $wrapper->field_address->value();
  $address_render_array = addressfield_generate($addressfield_object, $handlers, $context);
  $markup = drupal_render($address_render_array);
  return $markup;
}

function _ilr_sdc_listings_generate_request_info_markup($course) {
  $wrapper = ilr_get_node_wrapper($course);
  $markup = '<a class="button button-request-info course" data-nid="'.$course->nid.'">Request';
  $markup .= '<span class="course-info">'.$wrapper->label().'</span></a>';
  $markup .= '<span class="request-info">Schedule customized delivery to your organization</span>';
  return $markup;
}

function _ilr_sdc_listings_generate_class_timespan_markup($class_node) {
  $type = ' workshop';
  $wrapper = ilr_get_node_wrapper($class_node);
  $datetimes = _ilr_sdc_listings_get_datetimes_for_class($class_node);
  $interval = $datetimes['start']->diff($datetimes['end']);
  if (_ilr_sdc_listings_is_multiyear_event($class_node)) {
    $type = ' class';
    $months = $interval->m;
    if ($months > 10) { // More than a year
      $months = round($months / 12);
      $timespan = $months . '-year';
    } // less than a year
    else {
      $timespan = $months . '-month';
    }
  }
  elseif (_ilr_sdc_listings_is_multiday_event($class_node)) {
    $days = $interval->d;
    if ( $days > 10) { // More than a week
      $weeks = round($days / 7);
      $timespan = $weeks . '-week';
    } // less than a week
    else {
      $timespan = $days + 1 . '-day';
    }
  } // Single day event
  else {
    if ($interval->h < 1) { // Less than an hour
      $timespan = $interval->m . '-minute';
    } // more than an hour
    else {
      $hours = $interval->h;
      $timespan = ($hours > 4) ? '1-day' : '-hour';
    }
  }
  return '<span class="timespan">'. $timespan . $type .' </span>';
}

function _ilr_sdc_listings_generate_class_time_location_markup($class_node) {
  $markup = '';
  $wrapper = ilr_get_node_wrapper($class_node);
  $city = $wrapper->field_address->locality->value();
  $state = $wrapper->field_address->administrative_area->value();
  $markup .= _ilr_sdc_listings_format_class_date_and_time($class_node);
  if (!empty($city)) {
    $markup .= "<span class='location'>$city, $state</span>";
  }
  return $markup;
}

function _ilr_sdc_listings_generate_deadline_markup($class_node) {
  $markup = '';
  $wrapper = ilr_get_node_wrapper($class_node);
  $deadline = $wrapper->field_registration_end_date->value();
  $datetimes = _ilr_sdc_listings_get_datetimes_for_class($class_node);
  $deadline = $datetimes['start'];
  $deadline = $deadline->format('M j');
  $markup = '<span class="deadline">Register by '.$deadline.'</span>';
  return $markup;
}

function _ilr_sdc_listings_get_class_registration_url($class) {
  global $base_url;
  $wrapper = ilr_get_node_wrapper($class);
  $url = variable_get('ilr_sdc_listings_reg_url', 'http://register.ilr.cornell.edu/registration/process/processcard.cfm');
  $url .= '?addClass=' . $wrapper->field_class_id->value();
  $course_nid = $wrapper->field_course->getIdentifier();
  $url .= "&courseurl=$base_url/node/$course_nid";
  return $url;
}

/**
 * Get class nids for this course.
 * @param $course_node
 * @return array
 *  nids for classes
 */
function _ilr_sdc_listings_get_classes_for_course($course_node, $class_nids = NULL) {
  $today = date('Y-m-d');
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'sdc_class')
    ->propertyCondition('status', 1)
    ->fieldCondition('field_course', 'target_id', $course_node->nid)
    ->fieldCondition('field_registration_end_date', 'value', $today, '>=')
    ->fieldOrderBy('field_class_dates', 'value');
  if ($class_nids) {
    $query->propertyCondition('nid', $class_nids);
  }
  $results = $query->execute();
  if (!empty($results['node'])) {
    return array_keys($results['node']);
  }
  return array();
}

/**
 * Checks whether the registration deadline is different from the start date
 */
function _ilr_sdc_listings_has_registration_deadline($class) {
  $wrapper = ilr_get_node_wrapper($class);
  $deadline = $wrapper->field_registration_end_date->value();
  $datetimes = _ilr_sdc_listings_get_datetimes_for_class($class);
  $date = new DateTime();
  $date->setTimestamp($deadline);
  return $date->format('Y-m-d') !== $datetimes['start']->format('Y-m-d');
}

/**
 * Implements hook_preprocess_hook()
 * Remove node URL from SDC Class and Faculty nodes.
 * Remove title from Class on teaser.
 */
function ilr_sdc_listings_preprocess_node(&$variables) {
  if ($variables['type'] == 'sdc_faculty') {
    $variables['remove_title_link'] = TRUE;
  }
  if ($variables['type'] == 'sdc_class') {
    if ($variables['view_mode'] == 'teaser') {
      $variables['title'] = '';
    }
    else {
      $variables['remove_title_link'] = TRUE;
    }

  }
  if ($variables['type'] == 'sdc_course') {
    $variables['foo'] = array('#markup'=> "<h2>Hello Mark</h2>");
    if ($variables['view_mode'] == 'teaser') {
      unset($variables['content']['links']['node']['#links']['node-readmore']);
    }
  }

}

/**
 * Alter the default value for a Views date argument.
 *
 * @param object $argument
 *   The argument object.
 * @param string $value
 *   The default value created by the argument handler.
 */
function ilr_sdc_listings_date_default_argument_alter(&$argument, &$value) {
  $view = $argument->view;
  if ($view->name == 'sdc_class_calendar' && $view->current_display == 'block_nav') {
    if ($url_month = _ilr_sdc_listings_get_url_month_arg()) {
      $value = $url_month;
    }
  }
}

function _ilr_sdc_listings_get_datetimes_for_class($class) {
  $wrapper = ilr_get_node_wrapper($class);
  // Need $class_date_value because DateTime didn't work with
  //  $wrapper->field_class_dates->value()['value']
  $class_date_value = $wrapper->field_class_dates->value();
  $utc = new DateTimeZone('UTC');
  $tz = new DateTimeZone('America/New_York');
  $start = new DateTime($class_date_value['value'], $utc);
  $end = new DateTime($class_date_value['value2'], $utc);
  $start->setTimezone($tz);
  $end->setTimezone($tz);
  return array(
    'start' => $start,
    'end'   => $end,
  );
}
/**
 * Get Views Month Arg from URL.
 *
 * @return string
 *  Month in format YYYY-MM
 */
function _ilr_sdc_listings_get_url_month_arg() {
  if ($url_date = arg(_ilr_sdc_listings_get_path_alias_index())) {
    $value = substr($url_date, 0, 7);
    return $value;
  }
  return NULL;
}

function _ilr_sdc_listings_get_path_alias_index() {
  $parts = explode('/', rtrim(ILR_SDC_PATH_ALIAS, '/'));
  return count($parts) + 1;
}

/**
 * Implements hook_views_pre_render().
 *
 * Attach month select form to Calender Nav Block.
 * @param $view
 *   The view object about to be processed.
 */
function ilr_sdc_listings_views_pre_render(&$view) {
  if ($view->name == 'sdc_class_calendar' && $view->current_display == 'block_nav') {
    $nav = '';
    if (arg(2) == 'calendar-day') {
      $month = _ilr_sdc_listings_get_url_month_arg();
      $month_label = t('Back to @month ', array('@month' => date('F Y', strtotime($month))));
      $url = _ilr_sdc_listings_calendar_month_url($month, FALSE);
      $nav = '<p>' . l($month_label, $url, array('query' => _ilr_sdc_listings_get_field_query_values())) . '</p>';
    }
    $month_form = drupal_get_form('_ilr_listings_sdc_select_month_form');
    $nav .= drupal_render($month_form);
    $view->attachment_before = $nav;
  }
}

/**
 * Form to select month in Calendar Nav.
 *
 * Form redirects via javascript.
 */
function _ilr_listings_sdc_select_month_form($form, &$form_state) {
  if ($url_month = _ilr_sdc_listings_get_url_month_arg()) {
    $start_month = $url_month;
  }
  else {
    if (ILR_SDC_PATH_ALIAS == current_path()) {
      // Viewing all classes, not by date.
      $start_month = NULL;
    }
    else {
      $start_month = date('Y-m');
    }

  }

  $month_options = _ilr_sdc_listings_get_month_options($start_month, 15);

  $form['ilr_sdc_month_redirect'] = array(
    '#type' => 'select',
    '#options' => $month_options,
    '#default_value' => '/' . _ilr_sdc_listings_calendar_month_url($start_month),
  );
  $form['#attached']['js'] = array(
    drupal_get_path('module', 'ilr_sdc_listings') . '/js/ilr_sdc_listings.js',
  );
  return $form;
}

/**
 * Get month options for dropdown.
 * @param $start_month
 * @param $month_count
 * @param $key_prefix
 * @return array
 *  key - URL to redirect to will include month Views argument.
 *  values - Label for month. "August 2014"
 */
function _ilr_sdc_listings_get_month_options($start_month, $month_count) {
  $date_selected = TRUE;
  if (!$start_month) {
    $start_month = date('Y-m');
    $date_selected = FALSE;
  }
  $month_options = array();
  if ($date_selected) {
    $half_count = round($month_count / 2);
    $month = date('Y-m', strtotime("-$half_count months", strtotime($start_month)));
    $earliest_month = date('Y-m', strtotime('-' . ILR_SDC_MAX_DAYS_PAST . ' days'));
  }
  else {
    $month = $earliest_month = $start_month;
  }
  // Make sure our starting isn't earlier than earliest month to show.
  while ($month < $earliest_month) {
    $month = date('Y-m', strtotime("+1 months", strtotime($month)));
  }
  $i = 0;
  while ($i++ < $month_count) {
    $view_url = '/' . _ilr_sdc_listings_calendar_month_url($month);
    $month_options[$view_url] = date('M Y', strtotime($month));
    $month = date('Y-m', strtotime("+1 months", strtotime($month)));
  }
  if (!$date_selected) {
    $month_options = array('' => 'Choose a month') + $month_options;
  }
  else {
    $month_options = array('/' . ILR_SDC_PATH_ALIAS => 'Full Listing') + $month_options;
  }
  return $month_options;
}

/**
 * Construct the redirect URL for the SDC Monthly calendar View.
 *
 * This handles any exposed filter field values that are in the URL.
 * @param $month
 *  Format YYYY-MM to work with Views contextual filter for date
 * @return string
 */
function _ilr_sdc_listings_calendar_month_url($month, $include_query_string = TRUE) {
  $url = ILR_SDC_PATH_ALIAS . "/calendar-month/$month";
  if ($include_query_string) {
    $query_parameters = _ilr_sdc_listings_get_field_query_values();
    $query_string = drupal_http_build_query($query_parameters);
    if ($query_string) {
      $url .= '?' . $query_string;
    }
  }
  return $url;

}

/**
 * Get query string values that relates to field exposed filters
 *
 * @see drupal_get_query_parameters
 * @return array
 */
function _ilr_sdc_listings_get_field_query_values() {
  $query_parameters = drupal_get_query_parameters();
  foreach (array_keys($query_parameters) as $query_key) {
    if (substr($query_key, 0, 6) !== 'field_') {
      unset($query_parameters[$query_key]);
    }
  }
  return $query_parameters;
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * form_id = ilr_editable_settings_form
 * @see ilr_editable_settings module.
 */
function ilr_sdc_listings_form_ilr_editable_settings_form_alter(&$form, &$form_state, $form_id) {
  $form['sdc_set'] = array(
    '#type' => 'fieldset',
    '#title' => t('SDC Course Listings Messages'),

  );
  $form['sdc_set']['sdc_class_full_full'] = array(
    '#type' => 'textarea',
    '#title' => t('Class is full message on class page'),
    '#default_value' => 'Seats in this session are limited. Please call 866-470-1922 to register.',
  );
  $form['sdc_set']['sdc_class_full_teaser'] = array(
    '#type' => 'textarea',
    '#title' => t('Class is full message on class list'),
    '#default_value' => 'Class is full, but other dates may be available',
  );
  $form['sdc_set']['sdc_class_not_available'] = array(
    '#type' => 'textarea',
    '#title' => t('Class is no longer available'),
    '#default_value' => 'This class date is no longer available.',
  );
  $form['sdc_set']['sdc_class_selected_not_available'] = array(
    '#type' => 'textarea',
    '#title' => t('Class SELECTED is no longer available'),
    '#default_value' => 'The class you selected is no longer available.',
  );
  $form['sdc_set']['sdc_class_no_sessions'] = array(
    '#type' => 'textarea',
    '#title' => t('Class has no sessions'),
    '#default_value' => 'There are currently no sessions offered.',
  );
  $form['sdc_set']['sdc_class_selected_full'] = array(
    '#type' => 'textarea',
    '#title' => t('Class selected is full'),
    '#default_value' => 'The class date you selected is full.',
  );
}

function ilr_sdc_listings_form_views_exposed_form_alter(&$form, &$form_state) {
  if (isset($form['field_online_class_value'])) {
    $form['field_online_class_value']['#options'] =
      array(
        'All' => 'Both',
        '0' => 'In-person',
        '1' => 'Online',
      );
  }
  $view = $form_state['view'];
  if ($view->name == 'sdc_class_calendar' && $view->current_display == 'block_nav') {
    // Set After Build function to hide filters.
    $form['#after_build'][] = '_ilr_sdc_listings_hide_view_filters';
  }
}

/**
 * #after_build callback to hide exposed filters
 *
 * If they hidden outside of #after_build Views will not respect filters
 * @param $form
 * @param $form_state
 * @return array
 */
function _ilr_sdc_listings_hide_view_filters($form, &$form_state) {
  $view = $form_state['view'];
  if ($view->name == 'sdc_class_calendar' && $view->current_display == 'block_nav') {
    //$form['submit']['#access'] = FALSE;
    $hide_elements = array('field_online_class_value', 'field_sdc_department_tid');
    foreach ($hide_elements as $hide_element) {
      $form[$hide_element]['#access'] = FALSE;
    }
    return $form;
  }

}


/**
 * Implements hook_entityform_presave.
 * Sets the registration date for registration forms
 * Sets the job postdate for alumni job postings
 */
function ilr_sdc_listings_entityform_presave($entityform) {
  if ($entityform->type == 'course_request') {
    $wrapper = entity_metadata_wrapper('entityform', $entityform);
    $course_nid = arg(1);
    $wrapper->field_course->set($course_nid);
  }
}

/**
 * Gets the mlid of a menu link based on the alias
 * See ilr_sdc_listings_update_7001()
 */
function _ilr_sdc_listings_get_mlid_of_path($path) {
  $mlid = array();
  $menu_info = db_select('menu_links' , 'ml')
    ->condition('ml.link_path' , $path)
    ->fields('ml', array('mlid', 'plid'))
    ->execute()
    ->fetchAll();

  if (count($menu_info)) {
    return $menu_info[0]->mlid;
  }
  return NULL;
}

/**
 * Returns the uri of the parent page
 * based on the pathauto alias rules
 * See ilr_sdc_listings_update_7001()
 */
function _ilr_sdc_listings_get_parent_path_alias($path) {
  $parts = explode('/', rtrim($path, '/'));
  $sliced = array_slice($parts, 0, -1);
  return implode("/", $sliced);
}

function _ilr_sdc_listings_get_class_detail_markup($classes, $add_button=FALSE) {
  $markup = '';
  foreach ($classes as $nid => $class_node) {
    $class_node_wrapper = ilr_get_node_wrapper($class_node);
    $class_id = $class_node_wrapper->field_class_id->value();
    // Confirm class is not full
    $full = $class_node_wrapper->field_is_full->value();
    if (!$full) {
      $markup .= '<div class="class-detail-toggle class-'.$class_id.'">';
      if ($add_button) {
        $markup .= _ilr_sdc_listings_generate_class_button_markup($class_node, TRUE);
      }
      if (!_ilr_sdc_listings_is_ondemand($class_node)) {
        $markup .= _ilr_sdc_listings_format_class_date_and_time($class_node);
        $markup .= _ilr_sdc_listings_generate_location_markup($class_node);
      }
      $markup .= _ilr_sdc_listings_generate_faculty_markup($class_node, $class_id);
      $markup .= '</div>';
    }
  }
  return $markup;
}

/**
 * @todo -test field_is_full
 */
function _ilr_sdc_listings_add_radio_markup(&$form, $classes) {
  $class_radios = array();
  if (count($classes) > 1) {
    foreach ($classes as $nid => $class) {
      $wrapper = ilr_get_node_wrapper($class);
      $class_id = $wrapper->field_class_id->value();
      if ($wrapper->field_is_full->value()) {
        _ilr_sdc_listings_add_course_full_markup($form, $class);
      } // Add the radio
      else {
        $class_radios[] = $class_id;
        $form[$class_id] = array(
          '#type' => 'radio',
          '#return_value' => $class_id,
          '#attributes' => array('name' => 'addClass'),
          // Ensure single value in $form_state
          '#parents' => array('addClass'),
        );
        $form['class_radio_label_' . $class_id] = array(
          '#type' => 'markup',
          '#markup' => _ilr_sdc_listings_generate_class_radio_label($class),
        );
      }
    }
    if (!empty($class_radios)) {
      // Set the first as checked
      $first_class_id = reset($class_radios);
      $form[$first_class_id]['#attributes']['checked'] = 'checked';
      $form['class_detail_rule'] = array(
        '#type' => 'markup',
        '#markup' => '<p class="details-rule">Details for your selected date</p>',
      );
    }
  }
}

function _ilr_sdc_listings_add_course_full_markup(&$form, $class) {
  $wrapper = ilr_get_node_wrapper($class);

  $form['course_details'] = array(
    '#type' => 'markup',
    '#markup' => '<span class="cost">$' . $wrapper->field_price->value() . '</span>',
  );
  $form['class_full_' . $wrapper->field_class_id->value()] = array(
    '#type' => 'markup',
    '#markup' => '<p class="class class-full">' . variable_get('sdc_class_full_teaser') . '</p>',
  );
}

function _ilr_sdc_listings_add_prefix_to_title($node, $type) {
  $wrapper = ilr_get_node_wrapper($node);
  $prefix = ($type == 'sdc_class')
    ? $wrapper->field_course->field_catalog_prefix->value()
    : $wrapper->field_catalog_prefix->value();
  $title = $node->title . ' (' . $prefix . ')';
  $node->title = $title;
  drupal_set_title($title);
}

/**
 * Updates the rendered course entity on classes
 * when classes are part of a series
 */
function _ilr_sdc_listings_update_reference(&$node) {
  $wrapper = ilr_get_node_wrapper($node);
  if ($wrapper->field_course_series->value() == 1) {
    $title = 'Part of the series: ';
    $title .= $node->title;
    unset($node->content['body']);
    $node->content['series_link'] = array(
      '#markup' => '<p class="link back-link"><a href="/node/'.$node->nid.'">&laquo; Back to the series description</a></p>',
    );
  }
  else {
    $title = '';
  }
  $node->title = $title;
}

/**
 * Specifies which of the course and class fields are protected from
 * being updated by the feeds import
 * Note that this should only be relevant on fields mapped to the feeds importer in ilr_sdc_listings.feeds_importer_default.inc. However, we can add them here as a failsafe
 */
function _ilr_sdc_listings_get_feeds_protected_fields() {
  return array(
    'sdc_course_importer' => array(
      'field_keywords',
      'body',
      'field_course_series',
    ),
    'sdc_class_importer' => array(
      'body',
    ),
    'sdc_faculty_importer' => array(
      'body',
    ),
  );
}

/**
 * Specifies which of the course and class fields are protected from
 * being edited in Drupal
 */
function _ilr_sdc_listings_get_protected_fields() {
  return array(
    'sdc_class_node_form' => array(
      'title',
      'field_address',
      'field_class_dates',
      'field_class_id',
      'field_course',
      'field_faculty',
      'field_is_full',
      'field_on_demand',
      'field_online_class',
      'field_registration_end_date',
      'field_building',
      'field_price'
    ),
    'sdc_course_node_form' => array(
      'title',
      'field_catalog_prefix',
      'field_credit_hours',
      'field_on_demand',
      'field_sdc_department',
      'field_price',
      'field_price_note',
    ),
    'sdc_faculty_node_form' => array(
      'title',
    ),
  );
}
