<?php
/**
 * @file
 * Code for the Forms feature.
 */

include_once 'forms.features.inc';
define('ILRWEB_EMAIL', 'ilrweb@cornell.edu');
define('ILRWEB_BCC_EMAIL', 'ilrwebemailcc@cornell.edu');

function forms_form_alter(&$form, &$form_state, $form_id) {
  switch ($form_id) {
    case("ilr_website_feedback_entityform_edit_form"):
      $form['actions']['submit']['#submit'][] = '_process_contact_form_website_feedback';
      break;
  }
}

/**
 * Web Site Feedback:  Custom function to process the form
 */
/**
 *
 */
function _process_contact_form_website_feedback(&$form) {
  // Get form fields and set some strings based on them
  $full_name = $form['field_full_name']['und'][0]['value']['#value'];
  if (strlen($full_name)) {
    $email_salutation = "Dear {$full_name},\n\n";
  }
  else {
    $email_salutation = "";
    $full_name = "Not specified";
  }

  $email = $form['field_email']['und'][0]['email']['#value'];

  $comments = $form['field_comments']['und'][0]['value']['#value'];

  // Set from field for user email
  $from_field_for_user_email = ILRWEB_EMAIL;

  // Set up params array for subject and content
  $params = array(
    'subject' => "ILR Web Site Feedback confirmation",
    'content' =>
      $email_salutation .
      "Thank you for your comments about the ILR Website. " .
      "You submitted the following information on " .
      _form_confirmation_date() . "\n\n" .
      "Name: {$full_name}\n" .
      "Email: {$email}\n" .
      "Comments: {$comments}\n\n" .
      "Sincerely,\n" .
      "ILR Web Team\n" .
      $from_field_for_user_email
    );

  // Email to user
  if (strlen($email) > 0) {
    drupal_mail(
        'forms_std_confirmation',
        'user_confirmation',
        $email,
        LANGUAGE_NONE,
        $params,
        $from_field_for_user_email
      );
  }

  // Set up params array for admin email
  $adminparams = array(
    'subject' => "ILR Web Site Feedback submitted",
    'content' =>
      "ILR Web Site Feedback form was submitted on " . _form_confirmation_date() . "\n\n" .
      "Name: {$full_name}\n" .
      "Email: {$email}\n" .
      "Comments: {$comments}\n\n" .
      "Respond promptly if user provided an email address, even if just to say Thank You.\n"
    );

  // Email to admin
  if (strlen($email)) {
    $from_field_for_admin_email = $email;
  }
  else {
    $from_field_for_admin_email = ILRWEB_EMAIL;
  }
  drupal_mail(
    'forms_std_confirmation',
    'admin_notification',
    ILRWEB_EMAIL,
    LANGUAGE_NONE,
    $adminparams,
    $from_field_for_admin_email
  );

}


/**
 * Custom function to format dates to appear in confirmation _scheinman_neutral_admin_emails
 */
function _form_confirmation_date() {
  return date("F j, Y") . " at " . date("g:i a");
}


/**
 * Implements hook_mail().
 * This is the email sent to the user
 */
function forms_std_confirmation_mail($key, &$message, $params) {
  $sitename = variable_get('site_name', 'Drupal');

  $message['headers']['MIME-Version'] = '1.0';
  $message['headers']['Content-Type'] = 'text/plain;charset=utf-8';
  $message['headers']['Bcc'] = ILRWEB_BCC_EMAIL;
  $message['subject'] = $params['subject'];
  $message['body'][] = $params['content'];
  $message['body'][] = "\n--\r";
  $message['body'][] = t("This is an automatic e-mail from $sitename.");
}
